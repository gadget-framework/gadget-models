# ---------------------------------------------------------------------
# Set the ringed seal model
require(tidyverse)

## tmp <- read.table("~/../valerio/Share/Gadget/ringed_seal/data/Ringed seals NRM 2019-02-27_KL_2019-03-05.csv", header=T, sep="\t") %>%
##        filter(Length < 200) %>% # remove out of scale record
##        mutate(Month = as.numeric(substring(Date_formatted,5,6)),
##               AgeX = ifelse(Month<=2, Age1+1, Age1)) # ringed seals birthday assumed on 1 March

tmp <- mfdb_sample_rawdata(mdb, c('age','sex','maturity_stage'),
                           list(## year=mfdb_unaggregated(),
                                year=year_range,
                                step = mfdb_unaggregated(),
                                area = mfdb_unaggregated(),
                                length = mfdb_interval("len", seq(0, 200, by = 1)),
                                age = mfdb_unaggregated(),
                                sex = mfdb_unaggregated(),
                                maturity_stage = mfdb_unaggregated(),
                                data_source='ringed_seal_individuals'))[[1]] %>%
    mutate(Length = raw_length,
           Weight = raw_weight/1000) #g2kg

## weight length relationship
lw.constants.rin <-
  tmp %>%
  select(Length,Weight) %>%
  na.omit() %>%
  mutate(Weight=Weight) %>%
  ## collect(n=Inf) %>%
  lm(log(Weight)~log(Length),.) %>% 
  broom::tidy() %>% 
  select(estimate)
## transport back to right dimension
lw.constants.rin$estimate[1] <- exp(lw.constants.rin$estimate[1])
lw.constants.rin <- data.frame(a=lw.constants.rin$estimate[1],
                               b=lw.constants.rin$estimate[2])
## ggplot(tmp,aes(Length,Weight)) +
##     geom_point() +
##     geom_line(data=data.frame(x=20:180,
##                               y=lw.constants.rin$a*(20:180)^lw.constants.rin$b),
##               aes(x,y), col=2)

## initial conditions sigma
init.sigma.rin0 <- init.sigma.rin <-
    tmp %>%
    select(year,age,Length) %>%
    na.omit() %>%
    group_by(age) %>%
    summarise(ml = mean(Length),
              ms = sd(Length))
## ggplot(init.sigma.rin0) +
##     geom_point(aes(age,ml)) +
##     geom_errorbar(aes(x=age,ymax=ml+ms,ymin=ml-ms))
# alternative use non-linear quantile regression
# 1 sd is approx 68% corresponding to qq16 and qq84
library(quantreg)
datLenAge <-
    tmp %>%
    select(step,age,Length) %>%
    mutate(AgeX2 = age + step/12-1/24) %>%
    na.omit()
grw.qregr50.rin <-
    datLenAge %>%
    nlrq(Length~Linf*(1-exp(-k*(AgeX2-t0))),. , start=list(Linf=130,k=0.2,t0=-1), tau=0.5) %>%
    broom::tidy() %>% 
    select(estimate)
grw.qregr50.rin <- data.frame(Linf= grw.qregr50.rin$estimate[1],
                              k   = grw.qregr50.rin$estimate[2],
                              t0  = grw.qregr50.rin$estimate[3])
grw.qregr16.rin <-
    datLenAge %>%
    nlrq(Length~Linf*(1-exp(-k*(AgeX2-t0))),. , start=list(Linf=130,k=0.2,t0=-1), tau=0.16) %>%
    broom::tidy() %>% 
    select(estimate)
grw.qregr16.rin <- data.frame(Linf= grw.qregr16.rin$estimate[1],
                              k   = grw.qregr16.rin$estimate[2],
                              t0  = grw.qregr16.rin$estimate[3])
grw.qregr84.rin <-
    datLenAge %>%
    nlrq(Length~Linf*(1-exp(-k*(AgeX2-t0))),. , start=list(Linf=130,k=0.2,t0=-1), tau=0.84) %>%
    broom::tidy() %>% 
    select(estimate)
grw.qregr84.rin <- data.frame(Linf= grw.qregr84.rin$estimate[1],
                              k   = grw.qregr84.rin$estimate[2],
                              t0  = grw.qregr84.rin$estimate[3])
## ggplot(datLenAge) +
##     geom_point(aes(AgeX2,Length)) +
##     geom_line(data=data.frame(x=0:40,
##                               y=grw.qregr50.rin$Linf*(1-exp(-grw.qregr50.rin$k*(0:40-grw.qregr50.rin$t0)))),
##               aes(x,y), col=2) +
##     geom_line(data=data.frame(x=0:40,
##                               y=grw.qregr16.rin$Linf*(1-exp(-grw.qregr16.rin$k*(0:40-grw.qregr16.rin$t0)))),
##               aes(x,y), col=3) +
##     geom_line(data=data.frame(x=0:40,
##                               y=grw.qregr84.rin$Linf*(1-exp(-grw.qregr84.rin$k*(0:40-grw.qregr84.rin$t0)))),
##               aes(x,y), col=3) +
##     geom_point(data=init.sigma.rin0,aes(age,ml), col=4) +
##     geom_errorbar(data=init.sigma.rin0,aes(x=age,ymax=ml+ms,ymin=ml-ms), col=4)
init.sigma.rin <- data.frame(age=1:30,
                              ml=grw.qregr50.rin$Linf*(1-exp(-grw.qregr50.rin$k*(1:30-grw.qregr50.rin$t0))),
                              ms1=grw.qregr50.rin$Linf*(1-exp(-grw.qregr50.rin$k*(1:30-grw.qregr50.rin$t0))) -
                                  grw.qregr16.rin$Linf*(1-exp(-grw.qregr16.rin$k*(1:30-grw.qregr16.rin$t0))),
                              ms2=grw.qregr84.rin$Linf*(1-exp(-grw.qregr84.rin$k*(1:30-grw.qregr84.rin$t0))) -
                                  grw.qregr50.rin$Linf*(1-exp(-grw.qregr50.rin$k*(1:30-grw.qregr50.rin$t0))))
init.sigma.rin <- init.sigma.rin %>%
                  mutate(ms = (ms1+ms2)/2) %>%
                  select(age,ml,ms)

## initial growth
datLenAge <-
    tmp %>%
    select(step,age,Length) %>%
    mutate(AgeX2 = age + step/12-1/24) %>% #***CHECK if birthday assumed 1 Jan
    na.omit()
grw.constants.rin <-
    datLenAge %>%
    nls(Length~Linf*(1-exp(-k*(AgeX2-t0))),. , start=list(Linf=190,k=1e-2,t0=0.2)) %>%
    broom::tidy() %>% 
    select(estimate)
grw.constants.rin <- data.frame(Linf= grw.constants.rin$estimate[1],
                                k   = grw.constants.rin$estimate[2],
                                t0  = grw.constants.rin$estimate[3])
## ggplot(datLenAge) +
##     geom_point(aes(AgeX2,Length)) +
##     geom_line(data=data.frame(x=0:40,
##                               y=grw.constants.rin$Linf*(1-exp(-grw.constants.rin$k*(0:40-grw.constants.rin$t0)))),
##               aes(x,y), col=2)

## initial guess for the maturity ogive
propMat <-
    tmp %>%
    ## mutate(matGrp=ifelse(AgeGrp=="", "unspec",
    ##               ifelse(AgeGrp=="Adult","adult","juvenile")),
    ##        matGrp=ifelse(matGrp=="unspec" & AgeX <= 3, "juvenile", # assume 0-3=juv and 6+=adu 
    ##               ifelse(matGrp=="unspec" & AgeX >= 6, "adult", matGrp))) %>%
    mutate(maturity_stage = ifelse(is.na(maturity_stage) & age <= 3, 1, # assume 0-3=juv and 6+=adu
                            ifelse(is.na(maturity_stage) & age >= 6, 5, maturity_stage))) %>%
    filter(!is.na(maturity_stage)) %>%
    mutate(matGrp = ifelse(maturity_stage==1, "imm", "mat"))  %>%
    mutate(lenGrp = round(Length/10)*10) %>%
    select(lenGrp,matGrp) %>%
    na.omit() %>%
    filter(matGrp != "unspec") %>%
    group_by(lenGrp,matGrp) %>% 
  dplyr::summarise(n=n()) %>%
  data.frame() %>%
  complete(matGrp,lenGrp, fill=list(n=0)) %>%
  group_by(lenGrp) %>% 
  dplyr::mutate(p=n/sum(n, na.rm=T)) %>% 
  filter(matGrp=="mat") %>%
  collect(n=Inf)
mat.constants.rin <- propMat %>%
  nls(p~1/(1+exp(-a*(lenGrp-l50))),. , start=list(a=0.1,l50=120)) %>%
  broom::tidy() %>% 
  select(estimate)
mat.constants.rin <- data.frame(a=mat.constants.rin$estimate[1],
                                l50=mat.constants.rin$estimate[2])
## ggplot(propMat) +
##     geom_point(aes(lenGrp,p)) +
##     geom_line(data=data.frame(x=20:180,
##                               y=1/(1+exp(-mat.constants.rin$a*(20:180-mat.constants.rin$l50)))),
##               aes(x,y), col=2)

# proportion maturity at age
propMatAge <-
    tmp %>%
    ## mutate(matGrp=ifelse(AgeGrp=="", "unspec",
    ##               ifelse(AgeGrp=="Adult","adult","juvenile")),
    ##        matGrp=ifelse(matGrp=="unspec" & AgeX <= 3, "juvenile", # assume 0-3=juv and 6+=adu 
    ##               ifelse(matGrp=="unspec" & AgeX >= 6, "adult", matGrp))) %>%
    mutate(maturity_stage = ifelse(is.na(maturity_stage) & age <= 3, 1, # assume 0-3=juv and 6+=adu
                            ifelse(is.na(maturity_stage) & age >= 6, 5, maturity_stage))) %>%
    filter(!is.na(maturity_stage)) %>%
    mutate(matGrp = ifelse(maturity_stage==1, "imm", "mat"))  %>%
    select(age,matGrp) %>%
    na.omit() %>%
    group_by(age,matGrp) %>%
  dplyr::summarise(n=n()) %>%
  data.frame() %>%
  complete(matGrp,age, fill=list(n=0)) %>%
  group_by(age) %>% 
  dplyr::mutate(p=n/sum(n, na.rm=T)) %>% 
  filter(matGrp=="mat") %>%
  collect(n=Inf)
matAge.constants.rin <- propMatAge %>%
  nls(p~1/(1+exp(-a*(age-a50))),. , start=list(a=0.1,a50=3.2)) %>%
  broom::tidy() %>% 
  select(estimate)
matAge.constants.rin <- data.frame(a=matAge.constants.rin$estimate[1],
                                   a50=matAge.constants.rin$estimate[2])
## ggplot(propMatAge) +
##     geom_point(aes(age,p)) +
##     geom_line(data=data.frame(x=0:15,
##                               y=1/(1+exp(-matAge.constants.rin$a*(0:15-matAge.constants.rin$a50)))),
##               aes(x,y), col=2) + xlim(0,10)

## initial population stable age structure and split by imm and mat
## init.pop <- read.table("../data/stable_age_structure_fert07.txt", header=T)
## init.pop <- init.pop %>%
##             mutate(age = Age) %>%
##             left_join(propMatAge) %>%
##             mutate(p = ifelse(age<=3, 0,  # assume 0-3=juv and 6+=adu
##                        ifelse(age>=6, 1, p))) %>%
##             mutate(Nimm = N*(1-p),
##                    Nmat = N*p) %>%
##             select(age,N,p,Nimm,Nmat)
# alternative from having run the model at equilibrium
init.pop <- read.table("~/../valerio/Share/Gadget/ringed_seal/ringed_seal_18.2/ringseal_01_equilibrium/WGTSeq/ageCompEq.txt", header=T)


## initial SR parameters for the BH model
sr.mu.rin <- 29 # from calculate_ssb_at_carrying_capacity.R 
sr.la.rin <- 7  #4
avgWgt <- 60 # assume 60 kg as avg adult weight
ssn <- seq(1000,190000,1000)
ssb <- ssn * avgWgt
y <- (1e3 * sr.mu.rin * ssb) / ((1e5 * sr.la.rin) + ssb)
## plot(ssb,y,cex=0.6)
## cbind(ssn,ssb,y)

## setup the immature stock first
rin.imm <-
  gadgetstock('rinimm',gd$dir,missingOkay = TRUE) %>%
  gadget_update('stock',
                minage = 0,
                maxage = 5,
                minlength = 40,
                maxlength = 140,
                dl = 5,
                livesonareas = 1) %>%
  gadget_update('refweight',
                data=data_frame(length=seq(.[[1]]$minlength,.[[1]]$maxlength,.[[1]]$dl),
                                mean=lw.constants.rin$a*length^lw.constants.rin$b)) %>% 
  gadget_update('doesgrow', ## note to self the order of these parameters make difference
                growthparameters=c(linf='#rin.Linf', 
                                   k=to.gadget.formulae(quote(0.01*rin.k)),
                                   alpha = '#rinimm.walpha',
                                   beta = '#rinimm.wbeta'),
                beta = to.gadget.formulae(quote(1e1*rin.bbin)),
                maxlengthgroupgrowth = 4) %>%
  gadget_update('naturalmortality',
                c(0.43, # 65-89% survival rate pup-subadults (Sundqvist et al 2012 Ambio)
                  rep('#rinimm.M',3),
                  to.gadget.formulae(quote((rinimm.M+rinmat.M)/2)), # intermediate M for those ages overlapping imm and mat
                  to.gadget.formulae(quote((rinimm.M+rinmat.M)/2)))) %>%
                ## c(0.13,rep('#rinimm.M',4))) %>% # assume 12% mortality for age0 and 8% for age1+ (Øigård et al 2012 on grey seal in NOR)
  ## gadget_update('initialconditions',
  ##               ## normalparam = data_frame(age = .[[1]]$minage:.[[1]]$maxage,
  ##               normalparam = data_frame(age = 1:.[[1]]$maxage,
  ##                                        area = 1,
  ##                                        age.factor = parse(text=sprintf('exp(-1*(rinimm.M+rin.init.F)*%1$s)*rinimm.init.%1$s',age)) %>% 
  ##                                          map(to.gadget.formulae) %>% 
  ##                                          unlist(),   
  ##                                        area.factor = '#rinimm.init.scalar',
  ##                                        mean = von_b_formula(age,linf='rin.Linf',k='rin.k',recl='rin.recl'),
  ##                                        stddev = init.sigma.rin$ms[age],
  ##                                        alpha = to.gadget.formulae(quote(1e-6 * rin.walpha)),
  ##                                        beta = '#rin.wbeta')) %>% 
  gadget_update('initialconditions',
                normalcond = data_frame(age = 1:.[[1]]$maxage,
                                         area = 1,
                                         age.factor = parse(text=sprintf('rinimm.init.%1$s',age)) %>% 
                                         ## age.factor = parse(text=sprintf('exp(-1*(rinimm.M+rin.init.F)*%1$s)*rinimm.init.%1$s',age)) %>% 
                                           map(to.gadget.formulae) %>% 
                                           unlist(),   
                                         area.factor = '#rin.init.scalar',
                                         ## area.factor = '#rinimm.init.scalar',
                                         mean = von_b_formula(age,linf='rin.Linf',k='rin.k',recl='rin.recl'),
                                         stddev = init.sigma.rin$ms[age],
                                         relcond = 1)) %>% 
  ## does"something" updates should also allow for other names, e.g. doesrenew -> recruitment etc..
  gadget_update('iseaten',1) %>%
  gadget_update('doeseat',
                suitability = list(paste(prey='venimm', type='function', suit_func='andersenfleet', p0='#p0rin2ven',p1='#p1rin2ven',p2="Modelfiles/rin.ven.sel",p3='(* 1 #p3rin2ven)',p4='(* 1 #p3rin2ven)',p5='(* 10 #p5rin2ven)', sep='\t'),
				   paste(prey='venmat', type='function', suit_func='andersenfleet', p0='#p0rin2ven',p1='#p1rin2ven',p2="Modelfiles/rin.ven.sel",p3='(* 1 #p3rin2ven)',p4='(* 1 #p3rin2ven)',p5='(* 10 #p5rin2ven)', sep='\t'),
				   paste(prey='her', type='function', suit_func='constant', alpha="Modelfiles/rin.her.sel", sep = '\t'),
				   paste(prey='other', type='function', suit_func='constant', alpha="Modelfiles/rin.oth.sel", sep = '\t')),
				   ## paste(prey='her', type='function', suit_func='exponential', alpha='#p0rin2her', beta='#p1rin2her', gamma='(* -0.1 #p2rin2her)', delta='#p3rin2her', sep = '\t'),
				   ## paste(prey='other', type='function', suit_func='exponential', alpha='#p0rin2oth', beta='#p1rin2oth', gamma='(* -0.1 #p2rin2oth)', delta='#p3rin2oth', sep = '\t')),
                ## suitability = list('\n',
                ##                     'venimm	function  gamma #p0rin2ven #p1rin2ven (* 0.01 #p2rin2ven)','\n',
                ##                     'venmat	function  gamma #p0rin2ven #p1rin2ven (* 0.01 #p2rin2ven)','\n',
                ##                     'her	function  constant #p0rin2her','\n',
                ##                     'other	function  constant #p0rin2oth)'),
                preference = list('\n',
                                  paste(prey='venimm', '#prefrin2ven', '\n', sep='\t'),
                                  paste(prey='venmat', '#prefrin2ven', '\n', sep='\t'),
                                  paste(prey='her',    '#prefrin2her', '\n', sep='\t'),
                                  paste(prey='other',  '#prefrin2oth', sep='\t')),
                ## preference = list('\n',
                ##                   'venimm	#prefrin2ven','\n',
                ##                   'venmat	#prefrin2ven','\n',
                ##                   'her          #prefrin2her','\n',
                ##                   'other	#prefrin2oth'),
                maxconsumption = list(m0='(* 1e-4 #m0rin)',m1='#m1rin',m2='#m2rin',m3='#m3rin'),
                ## maxconsumption = '(* 1e-2 #m0rin)  #m1rin  #m2rin  #m3rin',
                halffeedingvalue = '#rin.Hfeed') %>% 
  gadget_update('doesmature',
                maturityfunction = 'continuous',
                maturestocksandratios = 'rinmat 1',
                coefficients = '0 0 #rin.mat1 #rin.mat2') %>% # age-based maturity
                ## coefficients = '#rin.mat1 #rin.mat2 0 0') %>% # length-based maturity
  gadget_update('doesmove',
                transitionstocksandratios = 'rinmat 1',
                transitionstep = 4)
  ## gadget_update('doesrenew',
  ##               normalparam = data_frame(year = year_range,
  ##                                        step = 2,
  ##                                        area = 1,
  ##                                        age = .[[1]]$minage,
  ##                                        number = parse(text=sprintf('rin.rec.scalar*rin.rec.%s',year)) %>% 
  ##                                          map(to.gadget.formulae) %>% 
  ##                                          unlist(),
  ##                                        mean = von_b_formula(age,linf='rin.Linf',k='rin.k',recl='rin.recl'),
  ##                                        stddev = '#rin.rec.sd',
  ##                                        alpha = '#rinimm.walpha',
  ##                                        beta = '#rinimm.wbeta'))
rin.imm$initialconditions$minage <- 1
rin.imm$initialconditions$maxage <- 5
## rin.imm$initialconditions$minlength <- 40
## rin.imm$initialconditions$maxlength <- 140

rin.mat <-
  gadgetstock('rinmat',gd$dir,missingOkay = TRUE) %>%
  gadget_update('stock',
                minage = 4,
                maxage = 40,
                minlength = 90,
                maxlength = 160,
                dl = 5,
                livesonareas = 1) %>%
  gadget_update('refweight',
                data=data_frame(length=seq(.[[1]]$minlength,.[[1]]$maxlength,.[[1]]$dl),
                                mean=lw.constants.rin$a*length^lw.constants.rin$b)) %>% 
  gadget_update('doesgrow', ## note to self the order of these parameters make difference
                growthparameters=c(linf='#rin.Linf', 
                                   k=to.gadget.formulae(quote(0.01*rin.k)),
                                   alpha = '#rinmat.walpha',
                                   beta = '#rinmat.wbeta'),
                beta = to.gadget.formulae(quote(1e1*rin.bbin)),
                maxlengthgroupgrowth = 4) %>% 
  gadget_update('naturalmortality',
                c(to.gadget.formulae(quote((rinimm.M+rinmat.M)/2)), # intermediate M for those ages overlapping imm and mat
                  to.gadget.formulae(quote((rinimm.M+rinmat.M)/2)),
                  rep('#rinmat.M',35))) %>%
  ## gadget_update('initialconditions',
  ##               normalparam = data_frame(## age = .[[1]]$minage:.[[1]]$maxage,
  ##                                        age = .[[1]]$minage:15,
  ##                                        area = 1,
  ##                                        age.factor = parse(text=sprintf('exp(-1*(rinmat.M+rin.init.F)*%1$s)*rinmat.init.%1$s',age)) %>% 
  ##                                          map(to.gadget.formulae) %>% 
  ##                                          unlist(),
  ##                                        area.factor = '#rinmat.init.scalar',
  ##                                        mean = von_b_formula(age,linf='rin.Linf',k='rin.k',recl='rin.recl'),
  ##                                        stddev = init.sigma.rin$ms[age],
  ##                                        alpha = to.gadget.formulae(quote(1e-6 * rin.walpha)),
  ##                                        beta = '#rin.wbeta')) %>% 
  gadget_update('initialconditions',
                normalcond = data_frame(## age = .[[1]]$minage:.[[1]]$maxage,
                                        ## age = .[[1]]$minage:25,
                                        age = 4:25,
                                         area = 1,
                                         age.factor = parse(text=sprintf('rinmat.init.%1$s',age)) %>% 
                                         ## age.factor = parse(text=sprintf('exp(-1*(rinmat.M+rin.init.F)*%1$s)*rinmat.init.%1$s',age)) %>% 
                                           map(to.gadget.formulae) %>% 
                                           unlist(),
                                         area.factor = '#rin.init.scalar',
                                         ## area.factor = '#rinmat.init.scalar',
                                         mean = von_b_formula(age,linf='rin.Linf',k='rin.k',recl='rin.recl'),
                                         stddev = init.sigma.rin$ms[age],
                                         relcond = 1)) %>% 
  ## does"something" updates should also allow for other names, e.g. doesrenew -> recruitment etc..
  gadget_update('doesspawn',
                spawnfile=gadgetfile(paste0("Modelfiles/", stock_names[2], ".spawnfile"),
                components=list(
               	list(
		    spawnsteps = 1,
		    spawnareas = 1,
		    firstspawnyear = 1991,
		    lastspawnyear = 2020,
		    spawnstocksandratios = 'rinimm  1',
		    ## proportionfunction = 'constant  1',
		    proportionfunction = 'constant  0.5', # 50% (=females un der 50-50 ratio) will reproduce
		    mortalityfunction = 'constant	 0',
		    weightlossfunction = 'constant  0',
		    ## recruitment = 'ricker	(* 1e-3 #rin.spw.mu)	(* 1e-7 #rin.spw.la)',
		    ## recruitment = 'bevertonholt	(* 1e3 #rin.spw.mu)	(* 1e5 #rin.spw.la)',
		    recruitment = 'fecundity	#rin.spw.p0  0  0  1  0',
                    stockparameters = '#rin.recl  #rin.rec.sd  #rinimm.walpha  #rinimm.wbeta')))) %>% 
  gadget_update('iseaten',1) %>%
  gadget_update('doeseat',
                suitability = list(paste(prey='venimm', type='function', suit_func='andersenfleet', p0='#p0rin2ven',p1='#p1rin2ven',p2="Modelfiles/rin.ven.sel",p3='(* 1 #p3rin2ven)',p4='(* 1 #p3rin2ven)',p5='(* 10 #p5rin2ven)', sep='\t'),
				   paste(prey='venmat', type='function', suit_func='andersenfleet', p0='#p0rin2ven',p1='#p1rin2ven',p2="Modelfiles/rin.ven.sel",p3='(* 1 #p3rin2ven)',p4='(* 1 #p3rin2ven)',p5='(* 10 #p5rin2ven)', sep='\t'),
				   paste(prey='her', type='function', suit_func='constant', alpha="Modelfiles/rin.her.sel", sep = '\t'),
				   paste(prey='other', type='function', suit_func='constant', alpha="Modelfiles/rin.oth.sel", sep = '\t')),
				   ## paste(prey='her', type='function', suit_func='exponential', alpha='#p0rin2her', beta='#p1rin2her', gamma='(* -0.1 #p2rin2her)', delta='#p3rin2her', sep = '\t'),
				   ## paste(prey='other', type='function', suit_func='exponential', alpha='#p0rin2oth', beta='#p1rin2oth', gamma='(* -0.1 #p2rin2oth)', delta='#p3rin2oth', sep = '\t')),
                preference = list('\n',
                                  paste(prey='venimm', '#prefrin2ven', '\n', sep='\t'),
                                  paste(prey='venmat', '#prefrin2ven', '\n', sep='\t'),
                                  paste(prey='her',    '#prefrin2her', '\n', sep='\t'),
                                  paste(prey='other',  '#prefrin2oth', sep='\t')),
                maxconsumption = list(m0='(* 1e-4 #m0rin)',m1='#m1rin',m2='#m2rin',m3='#m3rin'),
                halffeedingvalue = '#rin.Hfeed')
## rin.mat$initialconditions$minage <- 4
## rin.mat$initialconditions$maxage <- 25
## rin.mat$initialconditions$minlength <- 90
## rin.mat$initialconditions$maxlength <- 160

## write to file
rin.imm %>% 
  write.gadget.file(gd$dir)

rin.mat %>% 
  write.gadget.file(gd$dir)


## write all the timevariable files
source("setup_timevariables_rin.R")

# ---------------------------------------------------------------------
## Sys.setenv(GADGET_WORKING_DIR=normalizePath(gd$dir))
## callGadget(s=1,log = 'init.log') #ignore.stderr = FALSE,

## ## update the input parameters with sane initial guesses
## read.gadget.parameters(sprintf('%s/params.in',gd$dir)) %>% 
##   ## init_guess('rin.rec.[0-9]',1,0.001,1000,1) %>%
##   ## init_guess('rinimm.init.[0-9]',1,0.001,1000,1) %>%
##   ## init_guess('rinmat.init.[0-9]',1,0.001,1000,1) %>%
##   ## init_guess('rec.[0-9]|init.[0-9]',1,0.01,100,1) %>%
##   ## init_guess('init.[0-9]',1,0.01,100,1) %>%
##   init_guess('rinimm.init.1',init.pop$Nimm[2],0,1000,0) %>%
##   init_guess('rinimm.init.2',init.pop$Nimm[3],0,1000,0) %>%
##   init_guess('rinimm.init.3',init.pop$Nimm[4],0,1000,0) %>%
##   init_guess('rinimm.init.4',init.pop$Nimm[5],0,1000,0) %>%
##   init_guess('rinimm.init.5',init.pop$Nimm[6],0,1000,0) %>%
##   init_guess('rinmat.init.4',init.pop$Nmat[5],0,1000,0) %>%
##   init_guess('rinmat.init.5',init.pop$Nmat[6],0,1000,0) %>%
##   init_guess('rinmat.init.6',init.pop$Nmat[7],0,1000,0) %>%
##   init_guess('rinmat.init.7',init.pop$Nmat[8],0,1000,0) %>%
##   init_guess('rinmat.init.8',init.pop$Nmat[9],0,1000,0) %>%
##   init_guess('rinmat.init.9',init.pop$Nmat[10],0,1000,0) %>%
##   init_guess('rinmat.init.10',init.pop$Nmat[11],0,1000,0) %>%
##   init_guess('rinmat.init.11',init.pop$Nmat[12],0,1000,0) %>%
##   init_guess('rinmat.init.12',init.pop$Nmat[13],0,1000,0) %>%
##   init_guess('rinmat.init.13',init.pop$Nmat[14],0,1000,0) %>%
##   init_guess('rinmat.init.14',init.pop$Nmat[15],0,1000,0) %>%
##   init_guess('rinmat.init.15',init.pop$Nmat[16],0,1000,0) %>%
##   init_guess('rinmat.init.16',init.pop$Nmat[17],0,1000,0) %>%
##   init_guess('rinmat.init.17',init.pop$Nmat[18],0,1000,0) %>%
##   init_guess('rinmat.init.18',init.pop$Nmat[19],0,1000,0) %>%
##   init_guess('rinmat.init.19',init.pop$Nmat[20],0,1000,0) %>%
##   init_guess('rinmat.init.20',init.pop$Nmat[21],0,1000,0) %>%
##   init_guess('rinmat.init.21',init.pop$Nmat[22],0,1000,0) %>%
##   init_guess('rinmat.init.22',init.pop$Nmat[23],0,1000,0) %>%
##   init_guess('rinmat.init.23',init.pop$Nmat[24],0,1000,0) %>%
##   init_guess('rinmat.init.24',init.pop$Nmat[25],0,1000,0) %>%
##   init_guess('rinmat.init.25',init.pop$Nmat[26],0,1000,0) %>%
      
##   init_guess('rin.recl',75,50,90,0) %>% 
##   init_guess('rin.rec.sd',7,4,10,0) %>% 
##   init_guess('rin.Linf',grw.constants.rin$Linf, 120, 180, 0) %>% 
##   init_guess('rin.k$',grw.constants.rin$k*100, 0.1, 100, 0) %>% 
##   init_guess('rin.bbin',0.9, 0.001, 50, 0) %>% 
##   init_guess('rin.hun.alpha', 0.9,  0.01, 3, 0) %>% 
##   init_guess('rin.hun.l50',100,70,120,0) %>% 
##   init_guess('rin.aco.alpha',1,0.1,10,0) %>% 
##   ## init_guess('rin.com2.alpha', 0.9,  0.01, 3, 1) %>% 
##   ## init_guess('rin.com2.l50',12,2,20,1) %>% 
##   ## init_guess('rin.ref.alpha', 0.9,  0.01, 3, 0) %>% 
##   ## init_guess('rin.ref.l50',12,2,20,1) %>% 
##   ## init_guess('rin.aco.alpha', 0.7,  0.01, 3, 0) %>% 
##   ## init_guess('rin.aco.l50',11.5,2,20,1) %>% 
##   ## init_guess('rin.sea.alpha', 0.7,  0.01, 3, 0) %>% 
##   ## init_guess('rin.sea.l50',11.5,2,20,1) %>% 
##   init_guess('rinimm.walpha',lw.constants.rin$a, 1e-10, 1,0) %>% 
##   init_guess('rinimm.wbeta',lw.constants.rin$b, 2, 4,0) %>% 
##   init_guess('rinmat.walpha',lw.constants.rin$a, 1e-10, 1,0) %>%
##   init_guess('rinmat.wbeta',lw.constants.rin$b, 2, 4,0) %>% 
##   init_guess('rin.spw.mu', sr.mu.rin, 1, 100, 0) %>% 
##   init_guess('rin.spw.la', sr.la.rin, 1, 1000, 1) %>% 
##   init_guess('rinimm.M$',0.12,0.001,1,0) %>% # 65-89% survival rate pup-subadults (Sundqvist et al 2012 Ambio)
##   init_guess('rinmat.M$',0.05129,0.001,1,0) %>% # approx 95% survival rate (Sundqvist et al 2012 Ambio)
##   ## init_guess('rin.rec.scalar',1e-2,1e-4,1,0) %>% 
##   init_guess('rin.init.scalar',1e2,1e-2,1e2,1) %>% 
##   ## init_guess('rinimm.init.scalar',1e2,1e-2,1e2,1) %>% 
##   ## init_guess('rinmat.init.scalar',1e2,1e-2,1e2,1) %>% 
##   init_guess('rin.mat2',mat.constants.rin$l50,90,130,0) %>% 
##   init_guess('rin.mat1',mat.constants.rin$a,0.1,5,0) %>%
## init_guess('rin.mat2',matAge.constants.rin$a50,1,6,1) %>% 
## init_guess('rin.mat1',matAge.constants.rin$a,0.1,5,1) %>%
##   ## init_guess('rin.init.F',0.1,0.01,1,0) %>%
## write.gadget.parameters(.,file=sprintf('%s/params.in',gd$dir))
